<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #525659; font-family: 'Sarabun', sans-serif; color: #000 !important; } 
        .border, .table-bordered, .table-bordered th, .table-bordered td, .border-bottom, .border-dark { border-color: #000000 !important; border-width: 1px !important; } 
        .sign-line { border-bottom: 1px dotted #000000 !important; width: 140px; margin: 5px auto; height: 5px; } 
        .page { background: white; width: 210mm; min-height: 297mm; padding: 15mm 20mm; margin: 10mm auto; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.3); } 
        .doc-footer { position: absolute; bottom: 10mm; right: 20mm; font-size: 12px; text-align: right; color: #000; } 
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î */
        .btn-mode { border: 2px solid white; min-width: 150px; }
        .btn-mode.active { border: 2px solid #0d6efd; background-color: #e9ecef; color: #0d6efd; font-weight: bold; }

        @page { size: A4; margin: 0; } 
        @media print { 
            body, html { background: white !important; margin: 0 !important; padding: 0 !important; width: 100%; height: 100%; } 
            .page { width: 100%; height: auto; margin: 0 !important; padding: 15mm 10mm !important; box-shadow: none !important; border: none !important; page-break-after: avoid; } 
            .no-print { display: none !important; } 
            .doc-footer { bottom: 10mm; right: 10mm; } 
            .mb-4 { margin-bottom: 1rem !important; } .p-3 { padding: 0.8rem !important; } 
        } 
        .signature-section { margin-top: auto; padding-top: 20px; padding-bottom: 30px; } 
    </style>
</head>
<body>

<div class="no-print text-center mt-3 mb-2">
    <div class="bg-dark p-3 d-inline-block rounded shadow-sm">
        <span class="text-white me-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span>
        <button onclick="switchMode('all')" id="btnAll" class="btn btn-light btn-sm btn-mode active">üìÑ ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏° (‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</button>
        <button onclick="switchMode('approved')" id="btnApp" class="btn btn-light btn-sm btn-mode ms-2">‚úÖ ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
    </div>
</div>

<div class="text-center mb-3 no-print">
    <button onclick="window.print()" class="btn btn-primary btn-lg shadow">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    <button onclick="window.close()" class="btn btn-secondary ms-2">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
</div>

<div class="page">
    <div class="text-center mb-4 border-bottom pb-3">
        <div class="d-flex align-items-center justify-content-center">
            <img src="" class="app-logo me-3" alt="Logo" style="height: 70px;">
            <div class="text-start">
                <h4 class="fw-bold m-0 text-dark" style="color: #000 !important;">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ö‡∏™‡∏ó‡πå‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏•‡∏≤‡∏™ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</h4>
                <small class="text-muted d-block" style="color: #333 !important;">328 ‡∏°.6 ‡∏ï.‡∏Ñ‡∏•‡∏≠‡∏á‡∏ô‡∏¥‡∏¢‡∏°‡∏¢‡∏≤‡∏ï‡∏£‡∏≤ ‡∏≠.‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠ ‡∏à.‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10560</small>
            </div>
        </div>
        <h5 class="mt-3 fw-bold" id="doc_title" style="color: #000 !important;">‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (Purchase Request)</h5>
        <div id="sub_title" class="small text-muted fst-italic" style="display:none;">(‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</div>
    </div>

    <div class="row border p-3 mb-3 rounded mx-0 fw-bold" style="color: #000;">
        <div class="col-6 mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <span id="v_pr_number" class="fw-normal">-</span></div>
        <div class="col-6 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: <span id="v_created_at" class="fw-normal">-</span></div>
        <div class="col-6 mb-2">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠: <span id="v_requester" class="fw-normal">-</span></div>
        <div class="col-6 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á: <span id="v_required_date" class="fw-normal text-danger">-</span></div>
        <div class="col-6 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å: <span id="v_department" class="fw-normal">-</span></div>
        <div class="col-6">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <span id="v_doc_status" class="fw-normal">-</span></div>
    </div>

    <table class="table table-bordered mb-2 table-sm">
        <thead class="table-light" style="border-color: #000 !important;">
            <tr class="align-middle fw-bold">
                <th class="text-center" width="5%">#</th>
                <th width="10%">‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th width="10%" class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th width="10%" class="text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                <th width="25%" class="text-center">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
        </thead>
        <tbody id="v_tableBody" style="border-color: #000 !important;"></tbody>
    </table>

    <div class="mt-2 px-1 fw-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span id="v_remark" class="fw-normal">-</span></div>

    <div class="signature-section">
        <div class="row text-center">
            <div class="col-4">
                <div class="fw-bold mb-2">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</div>
                <div class="mb-1 fw-bold" style="color: #000;"><span id="v_sign_requester"></span></div>
                <div class="sign-line"></div>
                <div class="small mt-1" style="color: #000;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ............/............/............</div>
            </div>
            <div class="col-4">
                <div class="fw-bold mb-2">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</div>
                <div class="mb-1 fw-bold" style="color: #000;" id="v_sign_head">( ........................................... )</div>
                <div class="sign-line"></div>
                <div class="small mt-1" style="color: #000;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ............/............/............</div>
            </div>
            <div class="col-4">
                <div class="fw-bold mb-2">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                <div class="mb-1 fw-bold" style="color: #000;" id="v_sign_manager">( ........................................... )</div>
                <div class="sign-line"></div>
                <div class="small mt-1" style="color: #000;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ............/............/............</div>
            </div>
        </div>
    </div>
    <div class="doc-footer">FQP-PUR-01:04 Rev.02</div>
</div>

<script src="logo.js"></script>
<script src="script.js"></script>
<script>
    let currentPRData = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
    async function initPage() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (!id) return;

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å script.js ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞ Override logic ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏≠‡∏á
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î
        if(typeof db !== 'undefined') {
            try {
                const { data: pr, error } = await db.from('purchase_requests').select('*').eq('id', id).single();
                if (error) throw error;
                currentPRData = pr;
                renderHeader(pr);
                renderTable('all'); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°)
            } catch (err) { alert('Error: ' + err.message); }
        }
    }

    function renderHeader(pr) {
        document.getElementById('v_pr_number').innerText = pr.pr_number;
        document.getElementById('v_created_at').innerText = new Date(pr.created_at).toLocaleDateString('th-TH');
        document.getElementById('v_requester').innerText = pr.requester;
        document.getElementById('v_department').innerText = pr.department;
        document.getElementById('v_doc_status').innerText = pr.status === 'processed' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
        document.getElementById('v_remark').innerText = pr.header_remark || '-';
        document.getElementById('v_sign_requester').innerText = `${pr.requester}`;
        document.getElementById('v_required_date').innerText = new Date(pr.required_date).toLocaleDateString('th-TH');
        
        if (pr.status === 'pending_manager' || pr.status === 'processed') { 
            document.getElementById('v_sign_head').innerHTML = `( ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ${pr.department} )<br><span class="text-success small" style="font-size:10px;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>`; 
        }
        if (pr.status === 'processed') { 
            document.getElementById('v_sign_manager').innerHTML = '( ‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏≤‡∏® ‡∏ñ‡∏¥‡πà‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå )<br><span class="text-success small" style="font-size:10px;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>'; 
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    window.switchMode = function(mode) {
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Active
        document.getElementById('btnAll').classList.remove('active');
        document.getElementById('btnApp').classList.remove('active');
        if(mode === 'all') document.getElementById('btnAll').classList.add('active');
        else document.getElementById('btnApp').classList.add('active');

        // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Subtitle
        document.getElementById('sub_title').style.display = (mode === 'approved') ? 'block' : 'none';

        renderTable(mode);
    }

    function renderTable(mode) {
        if(!currentPRData) return;
        const tbody = document.getElementById('v_tableBody'); 
        tbody.innerHTML = '';
        
        let itemsToShow = currentPRData.items;
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Approved
        if(mode === 'approved') {
            itemsToShow = itemsToShow.filter(item => item.status === 'approved');
        }

        if(itemsToShow.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</td></tr>`;
            return;
        }

        itemsToShow.forEach((item, index) => {
            let statusText = '';
            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î "All" ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î "Approved" ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            if (item.status === 'approved') {
                statusText = '<span class="fw-bold text-success">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
            } else if (item.status === 'rejected') {
                statusText = `<span class="text-decoration-line-through text-danger">‚ùå ${item.remark || '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}</span>`;
            } else {
                statusText = '‚è≥ ‡∏£‡∏≠';
            }

            // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î Approved ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
            if(mode === 'approved') statusText = '-';

            tbody.innerHTML += `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${item.code || '-'}</td>
                    <td>${item.description}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-center">${item.unit}</td>
                    <td class="text-center">${statusText}</td>
                </tr>`;
        });
    }

    window.onload = initPage;
</script>
</body>
</html>
